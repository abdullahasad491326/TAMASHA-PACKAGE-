<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tamasha Activation</title>
  <style>
    :root {
      --bgA: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%);
      --card: rgba(0,0,0,0.6);
      --accent: #ff6a00;
      --success: #4CAF50;
    }
    body {
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:Inter,system-ui,Arial;
      background:var(--bgA);
      color:#fff;
      padding:20px;
    }
    .card {
      width:100%;
      max-width:460px;
      background:var(--card);
      padding:28px;
      border-radius:16px;
      box-shadow:0 12px 40px rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.06);
    }
    h1 { margin:0 0 10px 0; font-size:20px; }
    p.sub { margin:0 0 18px 0; opacity:0.85; font-size:14px; }
    .field { margin-bottom:12px; position:relative; }
    input[type="text"], input[type="tel"] {
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03); color: #fff; font-size:15px;
    }
    button {
      width:100%; padding:12px; border-radius:10px; border:none; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:600; font-size:15px;
      margin-top:6px;
    }
    .small {
      display:inline-block; width:48%; margin-right:4%;
    }
    .small:last-child { margin-right:0; }
    .response {
      margin-top:16px; background:rgba(0,0,0,0.5); padding:12px; border-radius:8px;
      max-height:220px; overflow:auto; font-family: monospace; font-size:13px; white-space:pre-wrap;
      border:1px solid rgba(255,255,255,0.05);
    }
    .channel {
      display:block; margin-top:14px; text-decoration:none; text-align:center; padding:10px;
      border-radius:8px; background:#25D366; color:#fff; font-weight:700;
    }
    .hint { font-size:13px; opacity:0.8; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Tamasha 30 Days â€” Activation</h1>
    <p class="sub">25GB Data + 1500 On-Net Mins â€” enter Jazz number, send OTP, verify and subscribe.</p>

    <div class="field">
      <input id="mobile" type="tel" placeholder="92XXXXXXXXXX" />
    </div>

    <div class="field">
      <button id="sendBtn" onclick="sendSignup()">Send OTP</button>
    </div>

    <div class="field">
      <input id="code" type="text" placeholder="Enter OTP" />
    </div>

    <div class="field">
      <button id="verifyBtn" onclick="verifyAuth()">Verify OTP & Subscribe</button>
    </div>

    <div id="responseBox" class="response">API responses will appear here...</div>

    <a class="channel" href="https://whatsapp.com/channel/0029Vb9shWp4o7qPSrCXS603" target="_blank">ðŸ“¢ Join WhatsApp Channel</a>
    <div class="hint">Responses show raw API result (decoded if possible).</div>
  </div>

  <script>
    // stored values
    let otpData = {}; // will store otpId, salt, uuid, user_id, mobile etc
    let bearerToken = null;

    function pretty(obj) {
      try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); }
    }

    async function sendSignup() {
      const mobile = document.getElementById("mobile").value.trim();
      const box = document.getElementById("responseBox");
      if (!mobile) { box.innerText = "Please enter mobile number."; return; }
      box.innerText = "Sending OTP...";
      try {
        const resp = await fetch("/api/sign-up-wc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mobile })
        });
        const data = await resp.json();
        box.innerText = pretty(data);

        // try to extract useful otpData fields if present
        // many responses put important info under data.* â€” be tolerant
        const d = data && (data.data || data) || null;
        if (d) {
          // assign values if present
          if (d.otpId) otpData.otpId = d.otpId;
          if (d.salt) otpData.salt = d.salt;
          if (d.uuid) otpData.uuid = d.uuid;
          if (d.user_id) otpData.user_id = d.user_id;
          otpData.mobile = mobile;
        }
      } catch (err) {
        box.innerText = "Error: " + (err && err.message ? err.message : err);
      }
    }

    async function verifyAuth() {
      const mobile = document.getElementById("mobile").value.trim();
      const code = document.getElementById("code").value.trim();
      const box = document.getElementById("responseBox");
      if (!mobile || !code) { box.innerText = "Please enter mobile and OTP."; return; }
      box.innerText = "Verifying OTP...";

      // Build payload: include otpData fields if we have them
      const payload = {
        mobile: mobile,
        code: code,
        // attach otpData fields if present (otpId, salt, uuid, user_id)
        ...(otpData.otpId ? { otpId: otpData.otpId } : {}),
        ...(otpData.salt ? { salt: otpData.salt } : {}),
        ...(otpData.uuid ? { uuid: otpData.uuid } : {}),
        ...(otpData.user_id ? { user_id: otpData.user_id } : {})
      };

      try {
        const resp = await fetch("/api/authentication-wc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        box.innerText = pretty(data);

        // save token + user_id if returned
        const token = data && (data.token || (data.raw && data.raw.data && data.raw.data.token) || (data.raw && data.raw.token));
        const user_id = data && (data.user_id || (data.raw && data.raw.data && data.raw.data.user_id) || (data.raw && data.raw.user_id));

        if (token) {
          bearerToken = token;
          // store to otpData.user_id in case subscribe needs it
          if (user_id) otpData.user_id = user_id;
          box.innerText += "\n\nToken saved (you can now subscribe).";
        } else {
          // attempt to extract from nested fields
          if (data && data.raw && data.raw.data && data.raw.data.token) {
            bearerToken = data.raw.data.token;
            otpData.user_id = data.raw.data.user_id;
            box.innerText += "\n\nToken saved (you can now subscribe).";
          }
        }
      } catch (err) {
        box.innerText = "Error: " + (err && err.message ? err.message : err);
      }
    }

    async function subscribeNow() {
      // not used by UI directly (verifyAuth also subscribes if you want),
      // but available for manual calls.
      const box = document.getElementById("responseBox");
      const mobile = document.getElementById("mobile").value.trim();
      if (!bearerToken || !otpData.user_id) {
        box.innerText = "No token/user_id available. Verify OTP first.";
        return;
      }
      box.innerText = "Subscribing...";
      try {
        const resp = await fetch("/api/subscribe-dbss", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token: bearerToken,
            user_id: otpData.user_id,
            mobile: mobile
          })
        });
        const data = await resp.json();
        box.innerText = pretty(data);
      } catch (err) {
        box.innerText = "Error: " + (err && err.message ? err.message : err);
      }
    }

    // If you prefer verify step to immediately subscribe, call subscribeNow() after token saved.
    // The verifyAuth button currently only verifies and saves token; subscription can be executed separately by calling subscribeNow().
  </script>
</body>
</html>
